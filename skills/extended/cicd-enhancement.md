---
name: cicd-enhancement
description: Comprehensive CI/CD enhancement with GitHub Actions - security scanning, semantic-release, and automated deployments. Auto-triggers on CI/CD related requests.
auto-invoke-triggers:
  - "(ci/cd|cicd|CI/CD)"
  - "github actions"
  - "security scanning"
  - "semantic release"
  - "automated deployment"
  - "setup.*workflows?"
  - "add.*pipeline"
allowed-tools: TodoWrite, AskUserQuestion, Read, Write, Edit
---

# CI/CD Enhancement Skill

Comprehensive enhancement of GitHub Actions workflows including security scanning, automated version management, and deployment orchestration.

## Overview

This skill provides a complete CI/CD enhancement for Node.js/TypeScript monorepo projects with:

| Feature | Description |
|---------|-------------|
| **Security Scanning** | Enhanced npm audit with separate jobs per package, fails on high/critical vulnerabilities |
| **Semantic Release** | Automated version management based on conventional commits |
| **Automated Deployments** | Railway deployment triggered on releases |
| **Dependabot** | Automated dependency update PRs |
| **Branch Protection** | Required status checks before merging |

## File Structure

```
.github/
├── workflows/
│   ├── test.yml           # Lint, type-check, unit tests, e2e tests
│   ├── security.yml       # NPM audit for all packages
│   ├── release.yml        # Semantic-release (triggered after test/security pass)
│   └── railway-deploy.yml # Deploy to Railway on release
├── dependabot.yml         # Automated dependency updates
└── (existing workflows)

.releaserc.json           # Semantic-release configuration
package.json              # Updated with release script and dependencies
CHANGELOG.md              # Auto-generated by semantic-release
```

## Implementation Steps

### 1. Root package.json Updates

Add semantic-release dependencies and release script:

```json
{
  "scripts": {
    "release": "semantic-release"
  },
  "devDependencies": {
    "@semantic-release/changelog": "^6.0.3",
    "@semantic-release/commit-analyzer": "^11.1.0",
    "@semantic-release/git": "^10.0.1",
    "@semantic-release/github": "^9.2.6",
    "@semantic-release/release-notes-generator": "^12.1.0",
    "semantic-release": "^23.0.0"
  }
}
```

### 2. Semantic Release Configuration (.releaserc.json)

```json
{
  "branches": ["main"],
  "plugins": [
    "@semantic-release/commit-analyzer",
    "@semantic-release/release-notes-generator",
    ["@semantic-release/changelog", {"changelogFile": "CHANGELOG.md"}],
    ["@semantic-release/git", {
      "assets": ["package.json", "CHANGELOG.md"],
      "message": "chore(release): ${nextRelease.version} [skip ci]\\n\\n${nextRelease.notes}"
    }],
    "@semantic-release/github"
  ]
}
```

### 3. Security Workflow (.github/workflows/security.yml)

Key features:
- Separate jobs for webapp, scraper, and root packages
- Production dependencies audit (fail on moderate+)
- All dependencies audit (warn on low)
- High/critical vulnerability blocking
- JSON reports uploaded as artifacts (30-day retention)
- Summary output to GitHub Actions page
- Daily scheduled runs

### 4. Test Workflow Updates (.github/workflows/test.yml)

Remove the `security-audit` job (moved to security.yml).

### 5. Release Workflow (.github/workflows/release.yml)

Triggered by `workflow_run` after Test and Security workflows complete:
- Runs semantic-release
- Creates Git tags
- Updates CHANGELOG.md
- Creates GitHub Releases

### 6. Railway Deploy Workflow (.github/workflows/railway-deploy.yml)

Updates:
- Trigger on `release: created` event
- Add version metadata to deployments
- Create deployment status comments

### 7. Dependabot Configuration (.github/dependabot.yml)

Automated dependency updates for:
- Root package.json
- Webapp package.json (grouped: next-js, testing)
- Scraper package.json (grouped: testing)
- GitHub Actions

## Manual Setup Steps

### GitHub Repository Settings

#### A. Verify Existing Secrets
| Secret | Purpose | Required |
|--------|---------|----------|
| `CODECOV_TOKEN` | Coverage reporting | Yes |
| `RAILWAY_TOKEN` | Railway deployment | Yes |

#### B. Branch Protection (Settings → Branches)

Add rule for `main` branch:
- Require pull request before merging: 1 approval
- Require status checks to pass:
  - `Lint`
  - `Type Check`
  - `Unit Tests`
  - `E2E Tests`
  - `NPM Audit - Webapp`
  - `NPM Audit - Scraper`
- Require branches to be up to date before merging
- Include administrators

#### C. Enable Dependabot (Settings → Code security and analysis)
- Dependabot alerts
- Dependabot security updates

### Local Setup

```bash
# Install new dependencies
npm install

# Create initial CHANGELOG.md (if doesn't exist)
cat > CHANGELOG.md << 'EOF'
# Changelog

All notable changes to this project will be documented in this file.

## [Unreleased]

### Added
- Initial CI/CD infrastructure
- Automated security scanning
- Automated semantic-release
EOF

# Commit and push
git add .
git commit -m "feat: add comprehensive CI/CD with security scanning and semantic release"
git push origin main

# Create initial baseline tag
git tag -a v1.0.0 -m "Release: v1.0.0 - Initial release"
git push origin v1.0.0
```

## Conventional Commit Format

Semantic-release analyzes commit messages:

| Type | Bump | Example |
|------|------|---------|
| `feat:` | Minor | `feat: add user authentication` |
| `fix:` | Patch | `fix: resolve login bug` |
| `feat!:` | Major | `feat!: breaking API change` |
| `BREAKING CHANGE:` | Major | `feat: add new feature\n\nBREAKING CHANGE: removes old API` |

## Workflow Execution Order

```
Push to main/PR
    ↓
┌─────────────┐     ┌──────────────┐
│   Test.yml  │     │ Security.yml │
│             │     │              │
│ - Lint      │     │ - NPM Audit  │
│ - Type      │     │   (3 jobs)   │
│ - Unit      │     │              │
│ - E2E       │     │              │
└──────┬──────┘     └──────┬───────┘
       │                   │
       └─────────┬─────────┘
                 ↓ (both pass)
         ┌───────────────┐
         │  Release.yml  │
         │ (workflow_run)│
         │               │
         │ - Create tag  │
         │ - Update      │
         │   CHANGELOG   │
         │ - GitHub      │
         │   Release     │
         └───────┬───────┘
                 ↓ (release created)
         ┌───────────────────┐
         │ railway-deploy.yml│
         │                   │
         │ - Deploy version  │
         │ - Verify health   │
         └───────────────────┘
```

## Troubleshooting

### Release workflow not creating versions
- Verify commits follow conventional format
- Check Test and Security workflows passed
- Verify `GITHUB_TOKEN` has write permissions
- Check workflow logs for semantic-release errors

### NPM audit failing
- Run `npm audit fix` locally
- For vulnerabilities in transitive deps: `npm update`
- Check if false positive - adjust `--audit-level` if needed

### Railway deployment not triggering
- Verify release was created (check Releases page)
- Check workflow is triggered on `release: types: [created]`
- Verify `RAILWAY_TOKEN` secret is set

## Verification Checklist

- [ ] Dependencies installed: `npm install`
- [ ] Branch protection rules configured
- [ ] Dependabot enabled
- [ ] CHANGELOG.md created
- [ ] Initial commit pushed with conventional format
- [ ] Initial v1.0.0 tag created and pushed
- [ ] Test workflow runs successfully
- [ ] Security workflow runs successfully
- [ ] Release workflow runs after test/security
- [ ] Railway deployment triggers on release
