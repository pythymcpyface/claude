/**
 * Playwright Configuration for E2E Docker Tests
 *
 * This configuration is specifically for running tests against
 * Docker containers. Use run-e2e.sh to orchestrate the full test run.
 *
 * Generated by: create-e2e-docker
 */

import { defineConfig, devices } from "@playwright/test";

const isCI = !!process.env.CI;
const baseURL = process.env.E2E_BASE_URL || "http://localhost:<%= services.frontend.port %>";

export default defineConfig({
  // Test directory
  testDir: "./specs",

  // Run tests in parallel
  fullyParallel: true,

  // Fail build on CI if test.only is left in source
  forbidOnly: isCI,

  // Retry failed tests on CI
  retries: isCI ? <%= testing.retries %> : 0,

  // Limit workers on CI, use default locally
  workers: isCI ? 1 : undefined,

  // Global timeout
  timeout: <%= testing.timeout %>,

  // Reporter configuration
  reporter: isCI
    ? [
        ["html", { outputFolder: "../../<%= testing.reportDir %>/playwright-report", open: "never" }] as const,
        ["json", { outputFile: "../../<%= testing.reportDir %>/results.json" }] as const,
        ["list"] as const,
        ["junit", { outputFile: "../../<%= testing.reportDir %>/junit.xml" }] as const,
      ]
    : [
        ["html", { outputFolder: "../../<%= testing.reportDir %>/playwright-report", open: "never" }] as const,
        ["json", { outputFile: "../../<%= testing.reportDir %>/results.json" }] as const,
        ["list"] as const,
      ],

  // Global setup and teardown
  globalSetup: "./global-setup.ts",
  globalTeardown: "./global-teardown.ts",

  // Shared settings for all tests
  use: {
    // Base URL for navigation
    baseURL,

<% if (services.frontend.framework === 'next' || services.frontend.framework === 'nuxt') { -%>
    // Storage state for authentication persistence
    storageState: undefined,
<% } -%>

    // Collect trace on retry for debugging
    trace: "on-first-retry",

    // Screenshot on failure
    screenshot: "only-on-failure",

    // Video on retry
    video: "on-first-retry",

    // Timeouts
    actionTimeout: 15000,
    navigationTimeout: 45000,

    // Ignore HTTPS errors (for local testing)
    ignoreHTTPSErrors: true,
  },

  // Configure projects for different browsers
  projects: [
    {
      name: "chromium",
      use: { ...devices["Desktop Chrome"] },
    },
    // Only run multiple browsers in CI if configured
<% if (ci.browsers.includes('firefox')) { -%>
    ...(isCI || process.env.BROWSER === "firefox"
      ? [
          {
            name: "firefox",
            use: { ...devices["Desktop Firefox"] },
          },
        ]
      : []),
<% } -%>
<% if (ci.browsers.includes('webkit')) { -%>
    ...(isCI || process.env.BROWSER === "webkit"
      ? [
          {
            name: "webkit",
            use: { ...devices["Desktop Safari"] },
          },
        ]
      : []),
<% } -%>
  ],

  // No webServer - containers are managed externally by run-e2e.sh
});
