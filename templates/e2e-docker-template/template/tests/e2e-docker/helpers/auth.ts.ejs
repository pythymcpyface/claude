/**
 * Auth Helper Utilities
 * Shared authentication functions for E2E tests
 *
 * Generated by: create-e2e-docker
 */

import { Page } from "@playwright/test";

const TOKEN_STORAGE_KEY = "<%= auth.tokenStorageKey %>";
const REFRESH_TOKEN_KEY = "<%= auth.refreshTokenKey %>";

/**
 * Login with email and password
 */
export async function login(page: Page, email: string, password: string): Promise<void> {
  await page.goto("<%= auth.loginPath %>");
  await page.getByLabel(/email address/i).fill(email);
  await page.getByLabel(/^password$/i).fill(password);
  await page.getByRole("button", { name: /sign in|login|log in/i }).click();
  await page.waitForURL(/^(?!.*<%= auth.loginPath %>)/, { timeout: 30000 });
}

/**
 * Logout current user
 */
export async function logout(page: Page): Promise<void> {
  // Click user menu
  await page.getByTestId("user-menu").click();
  // Click logout button
  await page.getByRole("button", { name: /logout|sign out/i }).click();
  // Wait for redirect to login
  await page.waitForURL(/<%= auth.loginPath %>/, { timeout: 10000 });
}

/**
 * Check if user is authenticated
 */
export async function isAuthenticated(page: Page): Promise<boolean> {
  try {
    await page.waitForSelector('[data-testid="sidebar"], [data-testid="dashboard"]', { timeout: 5000 });
    return true;
  } catch {
    return false;
  }
}

/**
 * Get auth token from localStorage
 */
export async function getAuthToken(page: Page): Promise<string | null> {
  return page.evaluate((key) => localStorage.getItem(key), TOKEN_STORAGE_KEY);
}

/**
 * Clear auth tokens from localStorage
 */
export async function clearAuth(page: Page): Promise<void> {
  await page.evaluate(({ tokenKey, refreshKey }) => {
    localStorage.removeItem(tokenKey);
    localStorage.removeItem(refreshKey);
  }, { tokenKey: TOKEN_STORAGE_KEY, refreshKey: REFRESH_TOKEN_KEY });
}

/**
 * Generate unique test email
 */
export function generateUniqueEmail(): string {
  const timestamp = Date.now();
  const random = Math.random().toString(36).slice(2, 7);
  return `test-${timestamp}-${random}@example.com`;
}

/**
 * Generate unique test domain
 */
export function generateUniqueDomain(): string {
  const timestamp = Date.now();
  return `test-${timestamp}.example.com`;
}
