/**
 * E2E Test Fixtures
 * Reusable test fixtures for authentication and API access
 *
 * Generated by: create-e2e-docker
 */

import { test as base, Page, APIRequest, BrowserContext } from "@playwright/test";

// Test user credentials (must match e2e-db-reset.ts)
export const TEST_USERS = {
<% testUsers.forEach((user, index) => { -%>
  <%= user.role || 'user' %><%= index > 0 ? index : '' %>: {
    email: "<%= user.email %>",
    password: "<%= user.password %>",
    name: "<%= user.name || 'Test User' %>",
  },
<% }); -%>
} as const;

// API base URL
const API_BASE_URL = process.env.E2E_API_URL || "http://localhost:<%= services.api.port %>";

// Fixture types
type E2EFixtures = {
  authenticatedPage: Page;
<% if (testUsers.some(u => u.role === 'admin')) { -%>
  adminPage: Page;
<% } -%>
  context: BrowserContext;
  apiClient: { baseUrl: string; request: APIRequest };
};

/**
 * Helper function to perform login
 */
async function performLogin(page: Page, email: string, password: string): Promise<void> {
  await page.goto("<%= auth.loginPath %>");
  await page.getByLabel(/email address/i).fill(email);
  await page.getByLabel(/^password$/i).fill(password);
  await page.getByRole("button", { name: /sign in|login|log in/i }).click();
  await page.waitForURL(/^(?!.*<%= auth.loginPath %>)/, { timeout: 30000 });
}

/**
 * Extended test with E2E fixtures
 */
export const test = base.extend<E2EFixtures>({
  // Standard authenticated page
  authenticatedPage: async ({ page }, use) => {
    await performLogin(page, TEST_USERS.<%= testUsers[0]?.role || 'user' %><%= testUsers.length > 1 ? '1' : '' %>.email, TEST_USERS.<%= testUsers[0]?.role || 'user' %><%= testUsers.length > 1 ? '1' : '' %>.password);
    await use(page);
  },

<% if (testUsers.some(u => u.role === 'admin')) { -%>
  // Admin authenticated page
  adminPage: async ({ page }, use) => {
    const adminUser = Object.values(TEST_USERS).find(u => u.email.includes("admin")) || TEST_USERS.<%= testUsers[0]?.role || 'user' %><%= testUsers.length > 1 ? '1' : '' %>;
    await performLogin(page, adminUser.email, adminUser.password);
    await use(page);
  },
<% } -%>

  // Fresh browser context
  context: async ({ browser }, use) => {
    const context = await browser.newContext();
    await use(context);
    await context.close();
  },

  // API client for direct API calls
  apiClient: async ({ request }, use) => {
    await use({
      baseUrl: API_BASE_URL,
      request,
    });
  },
});

// Re-export expect
export { expect } from "@playwright/test";

// Export test types
export type { E2EFixtures };
