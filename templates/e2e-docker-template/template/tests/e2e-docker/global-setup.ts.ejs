/**
 * Global Setup for E2E Docker Tests
 * Runs once before all tests
 *
 * Generated by: create-e2e-docker
 */

import { FullConfig } from "@playwright/test";

async function globalSetup(config: FullConfig) {
  console.log("\n========================================");
  console.log("  E2E Docker Tests - Global Setup");
  console.log("  Project: <%= projectName %>");
  console.log("========================================\n");

  const baseURL = config.projects[0]?.use?.baseURL || process.env.E2E_BASE_URL || "http://localhost:<%= services.frontend.port %>";
  const apiURL = process.env.E2E_API_URL || "http://localhost:<%= services.api.port %>";

  console.log("Configuration:");
  console.log(`  Frontend URL: ${baseURL}`);
  console.log(`  API URL: ${apiURL}`);
  console.log("");

  // Verify services are accessible
  const { request } = await import("@playwright/test");
  const context = await request.newContext();

  try {
    // Check API health
    const apiHealth = await context.get(`${apiURL}<%= services.api.healthEndpoint %>`);
    if (!apiHealth.ok()) {
      throw new Error(`API health check failed: ${apiHealth.status()}`);
    }
    console.log("  API health check: OK");

    // Check frontend is accessible
    const frontendCheck = await context.get(baseURL);
    if (!frontendCheck.ok()) {
      throw new Error(`Frontend check failed: ${frontendCheck.status()}`);
    }
    console.log("  Frontend check: OK");

    console.log("\nGlobal setup complete. Starting tests...\n");
  } catch (error) {
    console.error("\nService health check failed:", error);
    console.error("\nMake sure Docker containers are running:");
    console.error("  ./scripts/run-e2e.sh");
    throw error;
  } finally {
    await context.dispose();
  }
}

export default globalSetup;
