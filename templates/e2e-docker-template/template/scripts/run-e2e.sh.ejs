#!/bin/bash
# E2E Test Runner Script
# Orchestrates Docker containers and runs Playwright E2E tests
#
# Usage:
#   ./scripts/run-e2e.sh                    # Run with defaults
#   BROWSER=firefox ./scripts/run-e2e.sh    # Run with Firefox
#   WORKERS=2 ./scripts/run-e2e.sh          # Run with 2 workers
#   KEEP_CONTAINERS=true ./scripts/run-e2e.sh  # Keep containers after run
#
# Exit codes:
#   0 - All tests passed
#   1 - Tests failed
#   2 - Infrastructure error (containers failed to start)
#
# Generated by: create-e2e-docker

set -euo pipefail

# Configuration
COMPOSE_FILE="-f docker-compose.test.yml"
PROJECT_NAME="<%= projectName %>-e2e-$(date +%s)"
TIMEOUT=120
BROWSER="${BROWSER:-chromium}"
WORKERS="${WORKERS:-<%= testing.workers %>}"
KEEP_CONTAINERS="${KEEP_CONTAINERS:-false}"
REPORT_DIR="<%= testing.reportDir %>"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Cleanup function
cleanup() {
    local exit_code=$?
    if [ "$KEEP_CONTAINERS" != "true" ]; then
        log_info "Cleaning up containers..."
        docker-compose $COMPOSE_FILE -p "$PROJECT_NAME" down -v --remove-orphans 2>/dev/null || true
    else
        log_warning "Keeping containers (KEEP_CONTAINERS=true)"
    fi
    exit $exit_code
}

# Register cleanup on exit
trap cleanup EXIT INT TERM

# Check dependencies
check_dependencies() {
    log_info "Checking dependencies..."

    if ! command -v docker &> /dev/null; then
        log_error "Docker is not installed"
        exit 2
    fi

    if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
        log_error "Docker Compose is not installed"
        exit 2
    fi

    if ! command -v node &> /dev/null; then
        log_error "Node.js is not installed"
        exit 2
    fi

    log_success "All dependencies found"
}

# Start containers
start_containers() {
    log_info "Starting Docker containers..."
    docker-compose $COMPOSE_FILE -p "$PROJECT_NAME" up -d --build

    log_info "Waiting for services to be healthy..."
}

# Wait for service health
wait_for_healthy() {
    local service=$1
    local max_attempts=${2:-30}
    local attempt=0

    log_info "Waiting for $service to be healthy..."

    while [ $attempt -lt $max_attempts ]; do
        local health_status
        health_status=$(docker inspect --format='{{.State.Health.Status}}' "${PROJECT_NAME}-${service}-1" 2>/dev/null || echo "unknown")

        if [ "$health_status" = "healthy" ]; then
            log_success "$service is healthy"
            return 0
        fi

        attempt=$((attempt + 1))
        echo -n "."
        sleep 2
    done

    echo ""
    log_error "$service failed to become healthy after ${max_attempts} attempts"

    # Show logs for debugging
    log_info "Container logs for $service:"
    docker-compose $COMPOSE_FILE -p "$PROJECT_NAME" logs "$service" --tail=50

    return 1
}

# Reset database
reset_database() {
    log_info "Resetting and seeding test database..."

    # Database configuration
    local db_port="<%= services.database.port %>"
<% if (services.database.type === 'postgres') { -%>
    local db_url="postgresql://<%= services.database.user %>:<%= services.database.password %>@localhost:${db_port}/<%= services.database.database %>"
<% } else if (services.database.type === 'mysql') { -%>
    local db_url="mysql://<%= services.database.user %>:<%= services.database.password %>@localhost:${db_port}/<%= services.database.database %>"
<% } else if (services.database.type === 'mongodb') { -%>
    local db_url="mongodb://<%= services.database.user %>:<%= services.database.password %>@localhost:${db_port}/<%= services.database.database %>?authSource=admin"
<% } -%>

    # Run the database reset script
    DATABASE_URL="$db_url" npx tsx scripts/e2e-db-reset.ts

    if [ $? -eq 0 ]; then
        log_success "Database reset complete"
    else
        log_error "Database reset failed"
        exit 2
    fi
}

# Run Playwright tests
run_tests() {
    log_info "Running E2E tests with $BROWSER..."

    # Create reports directory
    mkdir -p "$REPORT_DIR"

    # Frontend configuration
    local frontend_port="<%= services.frontend.port %>"

    # Run Playwright tests
    cd tests/e2e-docker

    E2E_DOCKER=true \
    E2E_BASE_URL="http://localhost:${frontend_port}" \
    E2E_API_URL="http://localhost:<%= services.api.port %>" \
    npx playwright test \
        --project="$BROWSER" \
        --workers="$WORKERS" \
        --reporter=html,json \
        --output="../../$REPORT_DIR/"

    local exit_code=$?

    cd - > /dev/null

    return $exit_code
}

# Generate summary
generate_summary() {
    local exit_code=$1

    echo ""
    echo "========================================"
    echo "           E2E TEST SUMMARY"
    echo "========================================"
    echo ""

    if [ $exit_code -eq 0 ]; then
        log_success "All tests passed!"
    else
        log_error "Some tests failed (exit code: $exit_code)"
    fi

    echo ""
    echo "Reports generated at:"
    echo "  - HTML: $REPORT_DIR/playwright-report/index.html"
    echo "  - JSON: $REPORT_DIR/results.json"
    echo ""
}

# Main execution
main() {
    echo ""
    echo "========================================"
    echo "    E2E Docker Test Suite Runner"
    echo "    Project: <%= projectName %>"
    echo "========================================"
    echo ""
    echo "Configuration:"
    echo "  Browser: $BROWSER"
    echo "  Workers: $WORKERS"
    echo "  Project: $PROJECT_NAME"
    echo "  Keep containers: $KEEP_CONTAINERS"
    echo ""

    # Check dependencies
    check_dependencies

    # Start containers
    start_containers

    # Wait for all services
    wait_for_healthy "db" 30 || exit 2
    wait_for_healthy "app" 30 || exit 2
    wait_for_healthy "frontend" 20 || exit 2

    # Reset database
    reset_database

    # Run tests
    run_tests
    local test_exit_code=$?

    # Generate summary
    generate_summary $test_exit_code

    exit $test_exit_code
}

# Run main
main "$@"
