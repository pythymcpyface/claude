# E2E Test Environment - Generated Configuration
# Usage: docker-compose -f docker-compose.test.yml up -d
#
# This is a standalone configuration for E2E testing:
# - Uses ephemeral database (tmpfs for speed and isolation)
# - Configures test-specific environment variables
# - Sets aggressive health checks for faster feedback
#
# Generated by: create-e2e-docker

services:
  db:
    image: <%= services.database.image %>
    container_name: <%= projectName %>-test-db
    restart: unless-stopped
    environment:
<% if (services.database.type === 'postgres') { -%>
      - POSTGRES_USER=<%= services.database.user %>
      - POSTGRES_PASSWORD=<%= services.database.password %>
      - POSTGRES_DB=<%= services.database.database %>
<% } else if (services.database.type === 'mysql') { -%>
      - MYSQL_USER=<%= services.database.user %>
      - MYSQL_PASSWORD=<%= services.database.password %>
      - MYSQL_DATABASE=<%= services.database.database %>
      - MYSQL_ROOT_PASSWORD=<%= services.database.password %>
<% } else if (services.database.type === 'mongodb') { -%>
      - MONGO_INITDB_ROOT_USERNAME=<%= services.database.user %>
      - MONGO_INITDB_ROOT_PASSWORD=<%= services.database.password %>
<% } -%>
<% if (services.database.useTmpfs) { -%>
    tmpfs:
<% if (services.database.type === 'postgres') { -%>
      - /var/lib/postgresql/data
<% } else if (services.database.type === 'mysql') { -%>
      - /var/lib/mysql
<% } else if (services.database.type === 'mongodb') { -%>
      - /data/db
<% } -%>
<% } -%>
    ports:
      - "<%= services.database.port %>:<%= services.database.type === 'mongodb' ? 27017 : (services.database.type === 'mysql' ? 3306 : 5432) %>"
    networks:
      - <%= projectName %>-test-network
    healthcheck:
<% if (services.database.type === 'postgres') { -%>
      test: ["CMD-SHELL", "pg_isready -U <%= services.database.user %> -d <%= services.database.database %>"]
<% } else if (services.database.type === 'mysql') { -%>
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "<%= services.database.user %>", "-p<%= services.database.password %>"]
<% } else if (services.database.type === 'mongodb') { -%>
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
<% } -%>
      interval: 2s
      timeout: 5s
      retries: 10
      start_period: 5s

  app:
    build:
      context: <%= services.api.buildContext %>
      dockerfile: <%= services.api.dockerfile %>
    container_name: <%= projectName %>-test-api
    restart: unless-stopped
    ports:
      - "<%= services.api.port %>:<%= services.api.internalPort %>"
    environment:
      - NODE_ENV=test
      - PORT=<%= services.api.internalPort %>
<% if (services.database.type === 'postgres') { -%>
      - DATABASE_URL=postgresql://<%= services.database.user %>:<%= services.database.password %>@db:5432/<%= services.database.database %>
<% } else if (services.database.type === 'mysql') { -%>
      - DATABASE_URL=mysql://<%= services.database.user %>:<%= services.database.password %>@db:3306/<%= services.database.database %>
<% } else if (services.database.type === 'mongodb') { -%>
      - DATABASE_URL=mongodb://<%= services.database.user %>:<%= services.database.password %>@db:27017/<%= services.database.database %>?authSource=admin
<% } -%>
      - JWT_SECRET=e2e-test-jwt-secret-key-minimum-32-characters
      - JWT_EXPIRES_IN=604800
      - CORS_ORIGIN=http://localhost:<%= services.frontend.internalPort %>,http://frontend:<%= services.frontend.internalPort %>
<% Object.entries(services.api.envVars || {}).forEach(([key, value]) => { -%>
      - <%= key %>=<%= typeof value === 'string' ? value : JSON.stringify(value) %>
<% }); -%>
<% secrets.forEach(secret => { -%>
      - <%= secret %>=${<%= secret %>:-}
<% }); -%>
    depends_on:
      db:
        condition: service_healthy
    networks:
      - <%= projectName %>-test-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:<%= services.api.internalPort %><%= services.api.healthEndpoint %>"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 30s

  frontend:
    build:
      context: <%= services.frontend.buildContext %>
      dockerfile: <%= services.frontend.dockerfile %>
<% if (services.frontend.dockerfileTarget) { -%>
      target: <%= services.frontend.dockerfileTarget %>
<% } -%>
    container_name: <%= projectName %>-test-frontend
    restart: unless-stopped
    ports:
      - "<%= services.frontend.port %>:<%= services.frontend.internalPort %>"
    environment:
<% if (services.frontend.framework === 'vite' || services.frontend.framework === 'react') { -%>
      - VITE_API_URL=http://app:<%= services.api.internalPort %>
<% } else if (services.frontend.framework === 'next' || services.frontend.framework === 'nuxt') { -%>
      - NEXT_PUBLIC_API_URL=http://app:<%= services.api.internalPort %>
      - NUXT_PUBLIC_API_URL=http://app:<%= services.api.internalPort %>
<% } -%>
<% Object.entries(services.frontend.envVars || {}).forEach(([key, value]) => { -%>
      - <%= key %>=<%= value %>
<% }); -%>
    depends_on:
      app:
        condition: service_healthy
    networks:
      - <%= projectName %>-test-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:<%= services.frontend.internalPort %>"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 15s

networks:
  <%= projectName %>-test-network:
    driver: bridge
